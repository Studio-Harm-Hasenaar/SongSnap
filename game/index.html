<!DOCTYPE html>
<html>
<meta title="Musig guess" name="viewport" content="user-scalable=no" />
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;300;400;500;600;700;800&display=swap"
    rel="stylesheet">

<head>
    <meta charset="UTF-8">
    <title>Song Snap</title>
    <link rel="manifest" href="manifest.json">

    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css" />
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="common.js"></script>
    <script src=firebaseScripts.js></script>
    <link href="style.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="toggle-switch.css" rel="stylesheet" type="text/css" media="screen" />
</head>

<body>
    <div id='GameLoading'>
        <img class="LogoImage" src="images/SongSnap_Logo.png" alt="">
        <p id="loadingText">Het spel wordt geladen.<br><br>Even geduld a.u.b.</p>
    </div>
    <div id="container">
        <div id="loaded">
            <div id="main">
                <div id="user-signed-in" class="hidden">

                    <div id='GameNotActive'>
                        <img class="LogoImage" src="images/SongSnap_Logo.png" alt="">
                        <p id="gameNotActiveText">Het spel is niet actief!</p>
                        <img class="sadVinyl" src="images/SadVinyl.png" alt="sadVinyl">
                    </div>
                    <div id="GameActive">
                        <div id='PauseMenu'>
                            <h1 style="margin: 30px 0px 50px 0px">Instellingen</h1>
                            <h2>Spel gepauzeerd<br><br><br></h2>
                            <!--
                <p>Spotify volume</p>
                <div class="slidecontainer">
                    <input type="range" min="1" max="100" value="50" class="slider" id="spotifyVolumeSlider">
                </div>
                -->
                            <button class="BackButtonStyle backToLobby">Spel stoppen <img src="images/StopGame.png"
                                    alt="sadVinyl"></button>
                            <!--TODO: Fix logging-->
                            <button id="closeMenu" class="BottomButton">Verder spelen <img src="images/PlayIcon.png"
                                    alt="sadVinyl"></button>
                        </div>
                        <div id='Setup' class="screen">
                            <img class="LogoImage" src="images/SongSnap_Logo.png" alt="">
                            <p>Voer een naam in en druk op meedoen</p>
                            <div class="inputForm">
                                <p id="ErrorMessage"></p>
                                <form id="formSubmit">
                                    <input type="text" id="pname" class="pname" name="firstname" placeholder="Je naam">
                                    <input type="submit" value="Meedoen">
                                </form>
                                <button class="LogoutButton BackButtonStyle">Uitloggen</button>
                            </div>
                        </div>                        
                        <div id='LoadingPlaylists' class="screen">
                            <img class="LogoImage" src="images/SongSnap_Logo.png" alt="">
                            <p>Afspeellijsten laden,<br>Even geduld.</p>
                        </div>
                        <div id='PickPlaylist' class="screen">
                            <div id = "SearchPlaylistDiv" class="inputForm" style="margin-top:40px; margin-bottom:180px">
                                <form id="searchSubmit">
                                    <input type="text" id="searchText" class="psearchPlaylist" name="Search"
                                        placeholder="Zoeken">
                                    <input class="ChangeButtonStyle" type="submit" value="Zoek" name="Zoek">
                                </form>
                            </div>
                            <h3 id="viewingPlaylist">Kies een afspeellijst</h3>
                            <button class="ChangeButtonStyle inlineButton" id="upButton">▲</button>
                            <button class="ChangeButtonStyle inlineButton" id="downButton">▼</button>
                            <button id="chooseButton" style=" height:100% !important; min-height: 170px;">Kies afspeellijst</button>
                            <button class="BackButtonStyle" id="backToUserPlaylists">Stop zoeken</button>
                            <br><br><br><br>
                            <button class="BackButtonStyle backButton">Spel verlaten</button>
                        </div>
                        <div id='PickDuration' class="screen">
                            <h1>Spel opties</h1>
                            <!-- TODO: When only artist guessing is enabled, there can be cases that multiple of the same artists are present in a single guessing game and only one is correct. This means the player has no way of knowing which is correct!
                            TODO: Need to find a way to fix this first
                                <p id="songGuessAmount" >Wat wil je raden?</p>
                            <div id = "ArtistAndOrSongToggle" class="switch-toggle switch-holo">
                                <input type="radio" name="view3" id="artistsAndSongToggle" checked />
                                <label for="artistsAndSongToggle">Titel en<br>Artiest</label>
                                
                                <input type="radio" name="view3" id="artistOnlyToggle" />
                                <label for="artistOnlyToggle">Alleen<br>Artiest</label>
                                
                                <input type="radio" name="view3" id="nameOnlyToggle" />
                                <label for="nameOnlyToggle">Alleen<br>Titel</label>
                                <a href=""></a>
                              </div>
                              <br><br>
                              -->
                            <p id="songGuessAmount">Hoe veel liedjes?</p>
                            <form id="quantitySubmit">
                                <button class="ChangeButtonStyle inlineButton" id="set5songs">5</button>
                                <button class="ChangeButtonStyle inlineButton" id="set10songs">10</button>
                                <button class="ChangeButtonStyle inlineButton" id="set15songs">15</button>
                                <br><br>
                                <input type="number" id="quantity" name="hoeveel" min="1" max="5">
                                <input id="amountsubmit" type="submit" value="Beginnen">
                            </form>
                            <button class="BackButtonStyle" id="backToUserPlaylistsFromGuessAmount">Andere afspeellijst</button>
                        </div>
                        <div id='GameExplain' class="screen">
                            <h1>Spel uitleg</h1>
                            <p id="songGuessAmount">Kijk op het scherm voor informatie.</p>
                            <button id="skipExplainButton">Uitleg overslaan</button>
                        </div>
                        <div id='Guessing' class="screen"> 
                            <!--TODO: TEMP: DISABLED
                            <p id="scoringPositionLeftTop"></p>
                            -->
                            <p id="scoringRightTop"></p>
                            <div class="timeBarcontainer">
                                <div id="loader">
                                    <canvas id="circularLoader" width="200" height="200"></canvas>
                                </div>
                            </div>
                            <div class="wrapper">
                                <h1 id="guessText">Klaar?</h1>
                                <div class="guessButtons">
                                    <button id="BlueButtonReference" class="Blue">
                                        <P class="artistText" id="blue_artist">Artiest</P>
                                        <P class="songText" id="blue_song">Titel</P>
                                    </button>
                                    <button id="OrangeButtonReference" class="Orange">
                                        <P class="artistText" id="orange_artist">Artiest</P>
                                        <P class="songText" id="orange_song">Titel</P>
                                    </button>
                                    <button id="GreenButtonReference" class="Green">
                                        <P class="artistText" id="green_artist">Artiest</P>
                                        <P class="songText" id="green_song">Titel</P>
                                    </button>
                                    <button id="YellowButtonReference" class="Yellow">
                                        <P class="artistText" id="yellow_artist">Artiest</P>
                                        <P class="songText" id="yellow_song">Titel</P>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id='Scoring' class="screen">
                            <!--TODO: TEMP: DISABLED: 
                            <img class="pauseMenuButton" src="images/PauseIcon.png" alt="sadVinyl"></button>
                            -->
                            <h1 id="result">Fout!</h1>
                            <div class="guessButtons">
                                <button id="pickedAnswerButton" class="Orange">
                                    <P class="artistText" id="picked_artist">Foute ariets</P>
                                    <P class="songText" id="picked_song">Fout liedje</P>
                                </button>
                            </div>
                            <div id="showIfAnserWrong">
                                <h2 id="CorrectAnswerText">Correct antwoord</h2>
                                <div class="guessButtons">
                                    <button id="correctAnswerButton" class="Blue">
                                        <P class="artistText" id="correct_artist">Goede artiest</P>
                                        <P class="songText" id="correct_song">Goed liedje naam</P>
                                    </button>
                                </div>
                            </div>
                            <div id='scoringDiv'>
                                <h2 id="GainedPointText"><img id="fastestGuesser" src="images/FirstToGuess.png" alt=""
                                        width="130px"></h2>
                            </div>
                        </div>
                        <div id='FinalScoring' class="screen">
                            <h2 id="finalResultTitle">Spel over</h2>
                            <h1 id="finalResult">Nog een keer spelen?</h1>
                            <br><br><br>
                            <button class="BackButtonStyle backToLobby">Nieuw spel <img src="images/StopGame.png"
                                    alt="sadVinyl"></button>
                        </div>
                    </div>
                </div>
                <div id="user-signed-out" class="hidden">
                    <img class="LogoImage" src="images/SongSnap_Logo.png" alt="">
                    <p>Log in om je gebruikersnaam en score te onthouden.<br>Je kan ook als gast spelen!</p>
                    <div id="firebaseui-auth-container" style="margin-top: 350px; transform: scale(3)"></div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>


    $('.LogoutButton').click(function () {
        if (confirm("Weet je zeker dat je wil uitloggen?")) {
            firebase.auth().signOut();
        }
        return false;
    });

    setTimeout(() => {
        serverConnection()
    }, 1000);

    /////////////////////////Variables///////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////

    let firebaseDB = firebase.database();
    let firebaseAuth = firebase.auth();
    let activePlayerRef;
    var activeScreen = "";
    var pauseMenuOpen = false;
    var roomNumberCookie;
    var spotifyAccountName = "???";
    var wrongAudioFile = new Audio("audio/Wrong.wav");
    var correctAudioFile = new Audio("audio/Correct.wav");
    var userName = null;
    var latestGameState = null;
    var loggedIn = false;
    var guessType = null;

    //Timer circle
    var ctx = document.getElementById('circularLoader').getContext('2d');
    var al = 0;
    var start = 4.72;
    var cw = ctx.canvas.width;
    var ch = ctx.canvas.height;
    var diff;

    /////////////////////////Functions///////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////
    addEventListener('focus', event => { location.reload(); });
    
    function RoomNumberEntered() {
        if (roomNumberCookie != "" && roomNumberCookie != null) {
            var ref = firebase.database().ref(roomNumberCookie);
            ref.once("value")
                .then(function (snapshot) {
                    if (!snapshot.child("CurrentGameState").exists())
                        SetGameActive(false, "Spel is niet actief");
                    else
                    {
                        if (firebase.auth().currentUser != null)
                            userName = firebase.auth().currentUser.displayName;
                        if (userName != null && userName != "" && userName != "undefined")
                            $("#pname").val(userName);
                    }
                });

            //GAME STATE CHANGED!
            firebaseDB.ref(roomNumberCookie + "/CurrentGameState").on('value', function (snapshot) {
                if (snapshot.val() !== null) {
                    latestGameState = snapshot.val();
                    if (latestGameState == "Startup") {
                        if (loggedIn) location.reload();
                    }
                    if (latestGameState == "LoadingPlaylists" && loggedIn) {
                        SwitchActiveScreen("LoadingPlaylists");
                    }
                    if (latestGameState == "PickPlaylist" && loggedIn) {
                        SwitchActiveScreen("PickPlaylist");
                    }
                    if (latestGameState == "PickDuration") {
                        var maxAmount = Number(99);
                            SwitchActiveScreen("PickDuration")
                        $('#quanityLabel').html('Tussen 1 en ' + maxAmount);
                        $('#quantity').attr({
                            "max": maxAmount,
                        });
                    }
                    if (latestGameState == "GameExplain" && loggedIn) {
                        SwitchActiveScreen("GameExplain");
                    }
                    if (latestGameState == "Guessing" && loggedIn)
                        SwitchActiveScreen("Guessing");
                    if (latestGameState == "Scoring" && loggedIn)
                        SwitchActiveScreen("Scoring");
                    if (latestGameState == "FinalScoring" && loggedIn)
                        SwitchActiveScreen("FinalScoring");
                    if (latestGameState == null)
                        SetGameActive(false, "Spel is niet actief");
                    else
                        SetGameActive(true);
                }
            });
        }
        else
            SetGameActive(false, "Geen kamernummer gevonden. Heb je de QR code gescand?");
    }

    //Switch between states (game active or not)
    function SetGameActive(gameActive, gameError = "") {
        $('#GameNotActive').css('display', gameActive ? 'none' : 'inline');
        $('#GameActive').css('display', gameActive ? 'inline' : 'none');
        if (!gameActive)
            $('#gameNotActiveText').html(gameError);
        $('#GameLoading').css('display', 'none');
    }

    //Switch between game screens when game is active
    function SwitchActiveScreen(screenToActivate) {
        disableAllScreens();
        $('#' + screenToActivate).css('display', 'inline');

        switch (screenToActivate) {
            case 'Scoring':
                SetPlayerScoreScreen();
                break;
                case 'PickPlaylist':                    
                    //Set selected playlist
                    firebaseDB.ref(getParameterByName("roomNumber") + "/SelectedPlaylist").once('value', function (snapshot) {
                        var val = snapshot.val();
                        if (val !== null && loggedIn)
                        {
                            SetPlaylistContent(val);
                        }
                    });
                break;
        }
    }

    function SetPlaylistContent(val) {   
        $('#viewingPlaylist').html(val != "" ? "Kies een afspeellijst met de pijltjes" : "Wacht even tot de liedjes geladen zijn.");
        $('#chooseButton').html("Raad afspeellijst:<br>" + val);
        $('#chooseButton').css('display', val != "" ? 'inline' : 'none');
        $('#upButton').css('display', val != "" ? 'inline' : 'none');
        $('#downButton').css('display', val != "" ? 'inline' : 'none');
        $('#SearchPlaylistDiv').css('display', val != "" ? 'inline' : 'none');
    }

    function disableAllScreens() {
        let screens = document.querySelectorAll('.screen');
        screens.forEach(s => {
            s.style.display = 'none';
        })
    }

    //Set the clock timer during guessing
    function SetSim(newValue, maxValue) {
        al = newValue - 1;
        diff = ((al / maxValue) * Math.PI * 2 * 10).toFixed(2);
        ctx.clearRect(0, 0, cw, ch);
        ctx.lineWidth = 17;
        ctx.fillStyle = '#4285f4';
        ctx.strokeStyle = "#4285f4";
        ctx.textAlign = "center";
        ctx.font = "28px monospace";
        if (al > 0) {
            ctx.fillText(al, cw * .52, ch * .5 + 5, cw + 12);
        } else {
            ctx.fillText("", cw * .52, ch * .5 + 5, cw + 12);
        }
        ctx.beginPath();
        ctx.arc(100, 100, 75, start, diff / 10 + start, false);
        ctx.stroke();
        if (al >= 100) {
            clearTimeout(sim);
        }
    }

    //Generic function to get a parameter from the url by string
    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    //When the server makes connection, this gets called. Functions like an initiation of the client side
    function serverConnection() {
        $('#GameLoading').css('display', 'none');
    }

    //Connections
    var connectedRef = firebaseDB.ref('.info/connected');
    connectedRef.on('value', (snap) => {

        if (snap.val() === true) {
            console.log("Connection to firebase made");
        }
    });

    //Show the menu where the host can change volume and go back to the lobby.
    function ShowMenu(show) {
        if (firebase.auth().currentUser != null) {
            pauseMenuOpen = show;
            firebaseDB.ref(roomNumberCookie + "/GamePaused").once("value")
                .then(function (snapshot) {
                    if (snapshot.val() !== null)
                        firebaseDB.ref(roomNumberCookie + "/GamePaused").set(pauseMenuOpen);
                });
        }
    }

    //Return to the lobby for a new game.
    function BackToLobby() {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("resetGame");
            SwitchActiveScreen("PickPlaylist");
    }

    //Set the volume of spotify from the mobile.
    function SetSpotifyVolume(newVolume) {
        EmitMessage("setCurrentSpotifyVolumeFromGame", "{\"newVolume\":\n" + newVolume + "\n}");
    }

    function ShowErrorMessage(errorMessage) {
        $('#ErrorMessage').html("<i>" + errorMessage + "</i>");
        $('#pname').css("border-color", "#ea4146");
    }

    function SetUserLoggedId(){
        console.log("Logged in. Show content");
        $('#PauseMenu').css('display', pauseMenuOpen ? 'block' : 'none');

        //Check the roomnumber
        roomNumberCookie = getParameterByName("roomNumber");
        activePlayerRef = firebaseDB.ref(roomNumberCookie + '/ActivePlayers/');
        RoomNumberEntered();

        let updatedRoomNumberCookie = getParameterByName("roomNumber");
            if (updatedRoomNumberCookie != "" && user != null) {
                let firebaseRef = firebaseDB.ref(updatedRoomNumberCookie + "/ActivePlayers/" + user.uid + "/UserActive");
                firebaseRef.once("value", snapshot => {
                        //IF the player is registered in firebase and closes the window, update its active status
                    firebaseRef.onDisconnect().set(false);
                });

                //Is game paused?
                firebaseDB.ref(updatedRoomNumberCookie + "/GamePaused").on("value", snapshot => {
                    if (snapshot.val() !== null && loggedIn) {
                        console.log("Pause: "+snapshot.val());
                        $('#PauseMenu').css('display', snapshot.val() ? 'block' : 'none');
                    }
                });
                
                //Player position
                firebaseDB.ref(updatedRoomNumberCookie + "/ActivePlayers/" + user.uid + "/ScoringPlace").on("value", snapshot => {
                    if (snapshot.val() !== null && loggedIn) {
                        $('#finalResult').text(snapshot.val());
                        //TODO: TEMP: DISABLED:
                        //$('#scoringPositionLeftTop').text(snapshot.val() + " plaats");
                    }
                });

                //Player score
                firebaseDB.ref(updatedRoomNumberCookie + "/ActivePlayers/" + user.uid + "/Score").on("value", snapshot => {
                    if (snapshot.val() !== null && loggedIn) {
                        let playerScore = parseInt(snapshot.val());
                        if (playerScore == 0)
                            $("#scoringRightTop").html("Geen punten");
                        else if (playerScore == 1)
                            $("#scoringRightTop").html("1 punt");
                        else
                            $("#scoringRightTop").html(playerScore + " punten");
                    }
                });

                //Set guess information
                firebaseDB.ref(updatedRoomNumberCookie + "/CurrentQuestion/SongData").on('value', function (snapshot) {
                    if (snapshot.val() !== null && loggedIn)
                        SetGuessData(snapshot);
                });

                //Set selected playlist
                firebaseDB.ref(updatedRoomNumberCookie + "/SelectedPlaylist").on('value', function (snapshot) {
                    let val = snapshot.val();
                    if (val !== null && loggedIn)
                        SetPlaylistContent(val);
                });

                //Switch to searchContent
                firebaseDB.ref(updatedRoomNumberCookie + "/Host_SearchQuery").on('value', function (snapshot) {
                    let val = snapshot.val();
                    if (val !== null && loggedIn)
                    {
                        if (val != "")                        
                            $('#viewingPlaylist').html("Zoekresultaten:<br>'" + val + "'");
                        else
                            $('#viewingPlaylist').html("Kies een afspeellijst");

                        $('#backToUserPlaylists').css('display', val != "" ? 'inline' : 'none');
                        $('#searchSubmit').css('display', val != "" ? 'none' : 'inline');
                    }
                });                
            }
    }

    function SetupNewPlayer() {
        firebaseDB.ref(roomNumberCookie + "/CurrentGameState").once("value")
            .then(function (snapshot) {
                if (snapshot.val() !== null) {
                    activeScreen = snapshot.val();
                }

                var tempUserName = firebase.auth().currentUser.displayName;
                firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid).update({
                    PlayerName: tempUserName,
                    UserActive: true
                });

                $('#playerName').html('Welkom<br>' + tempUserName);
                SwitchActiveScreen(activeScreen);

                if (activeScreen == "Guessing") {
                    //Set guess information
                    firebaseDB.ref(roomNumberCookie + "/CurrentQuestion/SongData").once('value', function (snapshot) {
                        if (snapshot.val() !== null && loggedIn)
                            SetGuessData(snapshot);
                    });
                }

            });
        loggedIn = true;
    }

    function PlayerLeft() {
        console.log("left");
        firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid).once("value")
            .then(function (snapshot) {
                if (snapshot.val() !== null)
                    firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid + "/UserActive").set(false);
            });
    }

    //Set the 4 song titles and artists on the correct buttons.
    function SetGuessData(snapshot) 
    {
        //Get the type of game first
        if (guessType == null)
        {
            firebaseDB.ref(roomNumberCookie + "/ArtistAndOrSongToggle").once("value")
                    .then(function (guessTypeSnapshot) {
                        if (guessTypeSnapshot.val() !== null)
                                guessType = guessTypeSnapshot.val();
                                FillGuessData(snapshot);                            
                    });
        }    
        else
            FillGuessData(snapshot);    
    }

    var showArtist;
    var showSong;

    function FillGuessData(snapshot)
    {
        var guessState = snapshot.child("guessState").val();
        switch (guessState) {
            case 'ready':
                $('#guessText').html('Klaar?');
                SetButtonStyle(-1, '.5');
                break;
            case 'guess':
                //Get local time to set as guesstime (Only if there is no data yet)
                var startDate = new Date();
                var combinedStartDate = (startDate.getMinutes() * 60000) + (startDate.getSeconds() * 1000) + startDate.getMilliseconds();
                firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid + "/GuessStartTime").once("value")
                    .then(function (snapshot) {
                        if (snapshot.val() !== null)
                            if (snapshot.val() == "-1") {
                                firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid + "/GuessStartTime").set(combinedStartDate);
                            }
                    });
                    
            showArtist = (guessType != "nameOnlyToggle");
            showSong = (guessType != "artistOnlyToggle");
            CheckIfGuessed(1, 'Raad!');
                
                break;
            case 'timeup':
                CheckIfGuessed(.5, 'Tijd is op');
                break;
            case 'clean':
                $('#guessText').html('');
                SetButtonStyle(-1, '.5');
                break;
        }

        //Button state
        if (guessState == 'clean' || guessState == 'ready' || guessState == '') {
            $('#blue_artist').html("Artiest");
            $('#blue_song').html("Titel");

            $('#green_artist').html("Artiest");
            $('#green_song').html("Titel");

            $('#orange_artist').html("Artiest");
            $('#orange_song').html("Titel");

            $('#yellow_artist').html("Artiest");
            $('#yellow_song').html("Titel");
        }
        else
        {
            //BLUE
            var blueArtist = snapshot.child("artists").child(0).val();
            var blueSong = snapshot.child("titles").child(0).val();
            SetMusicGuessContent('#blue_artist', blueArtist, '#blue_song', blueSong,showArtist,showSong);

            //ORANGE
            var orangeArtist = snapshot.child("artists").child(1).val();
            var orangeSong = snapshot.child("titles").child(1).val();
            SetMusicGuessContent('#orange_artist', orangeArtist, '#orange_song', orangeSong,showArtist,showSong);

            //GREEN
            var greenArtist = snapshot.child("artists").child(2).val();
            var greenSong = snapshot.child("titles").child(2).val();
            SetMusicGuessContent('#green_artist', greenArtist, '#green_song', greenSong,showArtist,showSong);

            //YELLOW
            var yellowArtist = snapshot.child("artists").child(3).val();
            var yellowSong = snapshot.child("titles").child(3).val();
            SetMusicGuessContent('#yellow_artist', yellowArtist, '#yellow_song', yellowSong,showArtist,showSong);
        }

        $('#timeBarSecondsText').html('');
        $('.timeBarbar').css('width', '100%');
    }

    function SetButtonStyle(buttonToSet, newValue) {
        if (buttonToSet == -1) {
            $('#BlueButtonReference').css('opacity', newValue);
            $('#OrangeButtonReference').css('opacity', newValue);
            $('#GreenButtonReference').css('opacity', newValue);
            $('#YellowButtonReference').css('opacity', newValue);
        }
        else {
            $('#BlueButtonReference').css('opacity', '.5');
            $('#OrangeButtonReference').css('opacity', '.5');
            $('#GreenButtonReference').css('opacity', '.5');
            $('#YellowButtonReference').css('opacity', '.5');
            switch (buttonToSet) {
                case 0:
                    $('#BlueButtonReference').css('opacity', '1');
                    break;
                case 1:
                    $('#OrangeButtonReference').css('opacity', '1');
                    break;
                case 2:
                    $('#GreenButtonReference').css('opacity', '1');
                    break;
                case 3:
                    $('#YellowButtonReference').css('opacity', '1');
                    break;
            }
        }
    }

    function CheckIfGuessed(fallBackValue, guessText) {
        var guessedNumber = -1;
        firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid).once("value")
            .then(function (snapshot) {
                if (snapshot.val() !== null) {
                    guessedNumber = snapshot.child("SelectedAnswer").val();
                    if (guessedNumber != -1) {
                        SetButtonStyle(guessedNumber, '1');
                        $('#guessText').html('Geraden!');
                    }
                    else {
                        SetButtonStyle(-1, fallBackValue);
                        $('#guessText').html(guessText);
                    }
                }
            });
    }

    function ResetScoreScreen() {
        $("#showIfAnserWrong").css('display', 'none');
        $("#result").html('');
        $("#pickedAnswerButton").css('display', 'none');
        $("#correctAnswerButton").css('display', 'none');
        $("#picked_artist").html('');
        $("#picked_song").html('');
        $("#correct_artist").html('');
        $("#correct_song").html('');
        $("#GainedPointText").html('');
    }

    function SetMusicGuessContent(jquerryReferenceArtist, contentToSetArtist, jquerryReferenceSong, contentToSetSong, showArtist, showSong) {
        //Max 40 characters per song and artist

        //Artist
        var shortenedValueArtist = GetMaxCharacterLength(contentToSetArtist);
        if (!showArtist) shortenedValueArtist = "";
        $(jquerryReferenceArtist).html(shortenedValueArtist);

        //Song
        var shortenedValueSong = GetMaxCharacterLength(contentToSetSong);
        if (!showSong) shortenedValueSong = "";
        $(jquerryReferenceSong).html(shortenedValueSong);

        //Check if any has two rows of text and shorten if needed
        if (shortenedValueSong.length > 20 && shortenedValueArtist.length > 20) {
            $(jquerryReferenceSong)[0].style.fontSize = "1.9vh";
            $(jquerryReferenceArtist)[0].style.fontSize = "1.9vh";
        }
        else {
            $(jquerryReferenceSong)[0].style.fontSize = shortenedValueSong.length > 30 ? "2vh" : "2.5vh";
            $(jquerryReferenceArtist)[0].style.fontSize = shortenedValueSong.length > 30 ? "2vh" : "2.5vh";
        }
    }

    function GetMaxCharacterLength(textToshorten) {
        return textToshorten.length > 50 ? textToshorten.substring(0, 50) + "..." : textToshorten;
    }

    //Player has guessed
    function EnterGuess(newGuess) {
        //Get local time to set as guesstime
        var endDate = new Date();
        var combinedEndDate = (endDate.getMinutes() * 60000) + (endDate.getSeconds() * 1000) + endDate.getMilliseconds();
        firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid).once("value")
            .then(function (snapshot) {
                if (snapshot.val() !== null) {
                    //Get song data
                    firebaseDB.ref(roomNumberCookie + "/CurrentQuestion/SongData").once("value")
                        .then(function (songDataSnapShot) {
                            if (songDataSnapShot.val() !== null) {
                                if (snapshot.child("SelectedAnswer").val() == -1 && songDataSnapShot.child("guessState").val() == 'guess') {
                                    startDate = snapshot.child("GuessStartTime").val();
                                    var guessTimeMS = -1;
                                    if (combinedEndDate > startDate)
                                        guessTimeMS = combinedEndDate - startDate;
                                    firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid + "/GuessTimeMS").set(guessTimeMS);
                                    firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid + "/SelectedAnswer").set(newGuess);
                                    CheckIfGuessed(1, 'Geraden');
                                }
                            }
                        });
                }
            });

    }

    //Update the score.
    function SetPlayerScoreScreen() {
        ResetScoreScreen();
        firebaseDB.ref(roomNumberCookie + "/ActivePlayers/" + firebase.auth().currentUser.uid).once("value")
            .then(function (playerSnapShot) {
                if (playerSnapShot.val() !== null) {
                    //Get song data
                    firebaseDB.ref(roomNumberCookie + "/CurrentQuestion").once("value")
                        .then(function (songDataSnapShot) {
                            if (songDataSnapShot.val() !== null) {

                                var selectedAnswerInt = parseInt(playerSnapShot.child("SelectedAnswer").val());
                                var correctAnswerInt = parseInt(songDataSnapShot.child('SongData').child("correctAnswer").val());


                                var correct = (selectedAnswerInt == correctAnswerInt);
                                var pickedArtist = "";
                                var pickedSong = "";
                                if (selectedAnswerInt != -1) {
                                    pickedArtist = songDataSnapShot.child('SongData').child("artists").child(selectedAnswerInt).val();
                                    pickedSong = songDataSnapShot.child('SongData').child("titles").child(selectedAnswerInt).val();
                                }
                                var correctArtist = "";
                                var correctSong = "";
                                if (correctAnswerInt != -1) {
                                    correctArtist = songDataSnapShot.child('SongData').child("artists").child(correctAnswerInt).val();
                                    correctSong = songDataSnapShot.child('SongData').child("titles").child(correctAnswerInt).val();
                                }
                                var isFastestGuessed = firebase.auth().currentUser.uid == songDataSnapShot.child('SongData').child("fastestGuesserUID").val();

                                var pickedAnswerClass = GetColorClass(selectedAnswerInt);
                                var correctAnswerClass = GetColorClass(correctAnswerInt);

                                $("#showIfAnserWrong").css('display', correct ? 'none' : 'unset');
                                $("#result").html(correct ? 'Goed!' : 'Fout!');
                                $("#pickedAnswerButton").css('display', 'inline');
                                $("#correctAnswerButton").css('display', 'inline');
                                $("#pickedAnswerButton").attr('class', pickedAnswerClass);
                                $("#correctAnswerButton").attr('class', correctAnswerClass);
                                if (selectedAnswerInt == -1) {
                                    $("#result").html('Geen antwoord!');
                                    $("#picked_artist").html('???');
                                    $("#picked_song").html('???');
                                } else {
                                    $("#picked_artist").html(GetMaxCharacterLength(pickedArtist));
                                    $("#picked_song").html(GetMaxCharacterLength(pickedSong));
                                }
                                if (correct) {
                                    correctAudioFile.play();
                                } else {
                                    $("#correct_artist").html(GetMaxCharacterLength(correctArtist));
                                    $("#correct_song").html(GetMaxCharacterLength(correctSong));
                                    wrongAudioFile.play();
                                }
                                //TODO: Fix points gained   
                                /*
                                var pointConfirmation = "";
                                if (correct && isFastestGuessed) pointConfirmation = "2 punten erbij!";
                                if (correct && !isFastestGuessed) pointConfirmation = "1 punt erbij!";
                                if (!correct && isFastestGuessed) pointConfirmation = "Punt verloren!";
                                if (!correct && !isFastestGuessed) pointConfirmation = "";
                                $("#GainedPointText").html((isFastestGuessed ? '<img id="fastestGuesser" src="images/FirstToGuess.png" alt="" width="130px">' : '') + " " + pointConfirmation);
                                */

                                //SetSim(0, 99);
                                $('#Scoring').css('display', 'inline');
                            }
                        });
                }
            });
    }

    function GetColorClass(answerInt) {
        var returnValue = "";
        switch (answerInt) {
            case 0: returnValue = "Blue"; break
            case 1: returnValue = "Orange"; break
            case 2: returnValue = "Green"; break
            case 3: returnValue = "Yellow"; break
            default: returnValue = "White"; break
        }
        return returnValue;
    }
    let quant = document.querySelector('#quantity');
    quant.removeEventListener('change', ()=>{});
    quant.removeEventListener('value', ()=>{});
    //Set preset song duraction
    $("#set5songs").click(function (e) {
        e.preventDefault();
       quant.value = 5;
    });
    $("#set10songs").click(function (e) {
        e.preventDefault();
        quant.value = 10;
    });
    $("#set15songs").click(function (e) {
        e.preventDefault();
        quant.value = 15;
    });

    //The host changed the volume slider, update the volume of spotify via unity
    $("#spotifyVolumeSlider").change(function () {
        if (this.value != null)
            EmitMessage("setSpotifyVolume", "{\"newValue\":\"" + this.value + "\"}")
    });

    //The host clicked the up button during playlist selection
    $('#upButton').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("playlistUp");
        return false;
    });

    //The host clicked the down button during playlist selection
    $('#downButton').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("playlistDown");
        return false;
    });

    //The host selected a playlist during playlist selection
    $('#chooseButton').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("playlistSelect");
        return false;
    });

    //The host wants to skip tutorial
    $('#skipExplainButton').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("skipExplain");
        return false;
    });

    //The player has pressed the blue button during the guessing game
    $('#BlueButtonReference').on('click touchend', function (e) {
        EnterGuess(0);
        return false;
    });

    //The player has pressed the orange button during the guessing game
    $('#OrangeButtonReference').on('click touchend', function (e) {
        EnterGuess(1);
        return false;
    });

    //The player has pressed the green button during the guessing game
    $('#GreenButtonReference').on('click touchend', function (e) {
        EnterGuess(2);
        return false;
    });

    //The player has pressed the yellow button during the guessing game
    $('#YellowButtonReference').on('click touchend', function (e) {
        EnterGuess(3);
        return false;
    });

    //The host has clicked the pause button. The game should now pause when possible.
    $('.pauseMenuButton').on('click touchend', function (e) {
        ShowMenu(!pauseMenuOpen);
        return false;
    });

    //The host has closed the pause button. The game should now resume when possible.
    $('#closeMenu').on('click touchend', function (e) {
        ShowMenu(false);
        return false;
    });

    //The host has clicked on the return to lobby button. Confirm if this is what he/she wants and then return to lobby.
    $('.backToLobby').on('click touchend', function (e) {
        if (window.confirm("Wil je terug naar het hoofdmenu? Het huidige spel wordt dan gestopt.")) {
            ShowMenu(false);
            BackToLobby();
        }
        return false;
    });

    //A player has entered his/her data, check on the server if this data is valid.
    $('#formSubmit').submit(function (e) {

        var newDisplayname = $('#pname').val();

        if (newDisplayname != "") {
            const user = firebase.auth().currentUser;
            user.updateProfile({
                displayName: newDisplayname,
            }).then(() => {
                SetupNewPlayer();
            }).catch((error) => {
                ShowErrorMessage("Database fout: " + error);
            });
        }
        else
            ShowErrorMessage("Geen naam ingevuld");
        //RoomNumberEntered($('#pname').val());
        return false;
    });

    //The host has input how many songs there should be in this guessing game
    $('#quantitySubmit').submit(function (e) {
        e.preventDefault();
        var quessAmount = $('#quantity').val();
        if (quessAmount > 0)
        {
            //ArtistAndOrSongToggle
            //TODO: FIX
            /*            
            var toggleSetting = "ArtistAndSong";
            if(document.getElementById('artistsAndSongToggle').checked)
                toggleSetting = "artistsAndSongToggle";
            if(document.getElementById('artistOnlyToggle').checked)
                toggleSetting = "artistOnlyToggle";
            if(document.getElementById('nameOnlyToggle').checked)
                toggleSetting = "nameOnlyToggle";
            firebase.database().ref(roomNumberCookie + "/ArtistAndOrSongToggle").set(toggleSetting);
                */
            firebase.database().ref(roomNumberCookie + "/Host_SongAmount").set(quessAmount);
        }
        return false;
    });

    //The host wants to search for custom playlists
    $('#searchSubmit').submit(function () {
        //search
        var searchText = $('#searchText').val();

        if (searchText != "") {
            firebase.database().ref(roomNumberCookie + "/Host_SearchQuery").set(searchText);
        }
        return false;
    });

    //The host wants to return to the user playlist overview
    $('#backToUserPlaylists').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("backToUserPlaylist");
            firebase.database().ref(roomNumberCookie + "/Host_SearchQuery").set("");
    });

    $('#backToUserPlaylistsFromGuessAmount').click(function () {
        firebase.database().ref(roomNumberCookie + "/HostInput").set("backToUserPlaylist");
            firebase.database().ref(roomNumberCookie + "/Host_SearchQuery").set("");
    });

    //A player wants to return to the input field
    $('.backButton').click(function () {
        SwitchActiveScreen('Setup');
        PlayerLeft();
    });

  /////YET TO CONVERT

    /*
    //Update the timer during the guessing phase and show when the time is up.
    socket.on('setPlayerTimer', function(msg) {
        if (!guessed) {
  
            var obj = JSON.parse(msg);
  
            var seconds = eval(obj.seconds);
            var totalTime = eval(obj.totalTime);
            if (seconds != null && totalTime != null) {
                
                console.log("seconds: " + seconds);
                if (seconds < 2) {
                    GuessTimeOver();
                }
                SetSim(seconds, totalTime);
            } else {
                GuessTimeOver();
            }
        }
    });
  
    //The game has checked the current volume of the spotify client. Sync this with the volume on the host menu
    socket.on('setCurrentSpotifyVolumeFromGame', function(msg) {
        var currentVolume = eval(msg['volume']);
        var maxVolume = eval(msg['maxVolume']);
        console.log("spotify currentVolume: " + currentVolume);
        console.log("spotify maxVolume: " + maxVolume);
        if (currentVolume != -1 && maxVolume != -1) {
            $('#spotifyVolumeSlider').prop({
                'value': currentVolume,
                'max': maxVolume
            });
        }
    });
    */
</script>

</html>